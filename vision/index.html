<!DOCTYPE html>
<html>
	<head>
		<title>Computer Vision</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" type="text/css" href="style/reset.css">
		<link rel="stylesheet" type="text/css" href="style/main.css">
		<!--<link rel="icon" type="img/png" href="style/favicon.png" style="width:30px;">-->
		<!-- IMPORTED SCRIPTS -->
		<!-- NEED GOOGLE FONTS LATER -->
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script type="text/javascript" src="build/tracking-min.js"></script>
		<!-- NEED FIREBASE LATER -->
		<style>

			div#screen {
				width: 100vw;
				height: 300px;
				background: black;
			}

			video#camera, canvas#canvas {
				position: absolute;
			}

			canvas#canvas {

			}

			textarea#output {
				width: 400px;
				height: 200px;
			}

		</style>
	</head>

	<body>

		<h1>Vision</h1>

		<button onclick="dumpData();">Dump Data</button>

		<div id="screen">
			<video id="camera" width="400" height="300" preload autoplay="true" loop muted>Video</video>
			<canvas id="canvas" width="400" height="300">Canvas</canvas>
		</div>

		<p>Logging Output</p>
		<textarea id="output"></textarea>

		<script type="text/javascript">

			var output = document.getElementById('output');
			var video = document.getElementById('camera');
			var canvas = document.getElementById('canvas');
			var ctx = canvas.getContext('2d');
			ctx.strokeStyle = 'yellow';

			function flipHorizontal(domObj){
				domObj.style.cssText = "-moz-transform: scale(-1, 1); \
				-webkit-transform: scale(-1, 1); -o-transform: scale(-1, 1); \
				transform: scale(-1, 1); filter: FlipH;";
			}

			flipHorizontal(video);
			flipHorizontal(canvas);

			function clearCanvas(){
				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}

			function drawRect(r){
				ctx.beginPath();
				clearCanvas();
				ctx.rect(r.x, r.y, r.width, r.height);
				ctx.stroke();
			}

			// Blue Cap: rgb(50,86,231)
			// Pink Arm: rgb(243,168,172)
			// Green Point: rgb(133,197,179)
			// rgb(26,119,107)
			// rgb(242,142,147)

			function colorValidatorFactory(r, g, b){
				var validator = function(ri, gi, bi){
					var rRange = Math.abs(r - ri) < 50;
					var gRange = Math.abs(g - gi) < 50;
					var bRange = Math.abs(b - bi) < 50;
					if(rRange && gRange && bRange){
						return true;
					}
					else{
						return false;
					}
				}
				return validator;
			}

			tracking.ColorTracker.registerColor('capBlue', colorValidatorFactory(50, 86, 231));
			tracking.ColorTracker.registerColor('brushPink', colorValidatorFactory(243, 168, 172));
			tracking.ColorTracker.registerColor('glove', colorValidatorFactory(255,147,151));

			var colors = new tracking.ColorTracker(['capBlue']);

			var saved = [];

			function saveRect(rect){
				saved.push({
					timestamp: Date.now(),
					x: rect.x,
					y: rect.y,
					width: rect.width,
					height: rect.height
				});
			}

			function dumpData(){
				saved.sort(function(a, b){
					return a.timestamp - b.timestamp;
				});
				var start = saved[0].timestamp;
				var lines = saved.map(function(d){
					var time = d.timestamp - start;
					return [time, d.x, d.y, d.width, d.height].join(',');
				});
				var toPrint = ['timestamp', 'x', 'y', 'width', 'height'].join(',');
				for(var i = 0; i < lines.length; i++){
					toPrint += '\n' + lines[i];
				}
				output.value = toPrint;
			}

			colors.on('track', function(event){
				if(event.data.length === 0){
					//console.log('No colors detected.');
				}
				else{
					event.data.forEach(function(rect){
						//console.log(rect);
						drawRect(rect);
						saveRect(rect);
					});
				}
			});

			tracking.track('#camera', colors, {camera: true});
			

			console.log("LOADED MAIN");

			window.onerror = function(event){
				alert(event);
			}

		</script>
		
	</body>
</html>